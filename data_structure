
CREATE DATABASE IF NOT EXISTS `pharmacy_db` DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;
USE `pharmacy_db`;


DROP TABLE IF EXISTS `customers`;
CREATE TABLE IF NOT EXISTS `customers` (
  `customer_id` int(11) NOT NULL AUTO_INCREMENT,
  `customer_name` varchar(100) NOT NULL,
  `email` varchar(100) DEFAULT NULL,
  `phone` varchar(20) DEFAULT NULL,
  `address` varchar(255) DEFAULT NULL,
  `date_joined` date DEFAULT curdate(),
  PRIMARY KEY (`customer_id`),
  UNIQUE KEY `email` (`email`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;



DROP TABLE IF EXISTS `customer_points`;
CREATE TABLE IF NOT EXISTS `customer_points` (
  `customer_id` int(11) NOT NULL,
  `email` varchar(100) DEFAULT NULL,
  `total_points` int(11) DEFAULT 0,
  `created_date` date DEFAULT curdate(),
  `last_updated` date DEFAULT NULL,
  PRIMARY KEY (`customer_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;


DELIMITER $$

CREATE PROCEDURE add_customer_points(IN p_customer_id INT)
BEGIN
    DECLARE remaining_days INT;
    DECLARE earned_points INT;

    -- Calculate remaining days in the current month
    SET remaining_days = DAY(LAST_DAY(CURDATE())) - DAY(CURDATE());

    -- Calculate earned points
    SET earned_points = FLOOR(remaining_days / 8);

    -- Insert or update customer points
    INSERT INTO customer_points (customer_id, total_points, created_date, last_updated)
    VALUES (p_customer_id, earned_points, CURDATE(), CURDATE())
    ON DUPLICATE KEY UPDATE
        total_points = total_points + earned_points,
        last_updated = CURDATE();
END$$

DELIMITER ;


DROP TABLE IF EXISTS `inventory`;
CREATE TABLE IF NOT EXISTS `inventory` (
  `inventory_id` int(11) NOT NULL AUTO_INCREMENT,
  `med_id` int(11) DEFAULT NULL,
  `quantity` int(11) DEFAULT NULL,
  `price` decimal(10,2) DEFAULT NULL,
  `expiry_date` date DEFAULT NULL,
  `med_name` varchar(100) DEFAULT NULL,
  `category_name` varchar(100) DEFAULT NULL,
  `status` varchar(20) DEFAULT 'ACTIVE',
  PRIMARY KEY (`inventory_id`),
  KEY `med_id` (`med_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

DELIMITER $$

CREATE PROCEDURE generate_inventory_data()
BEGIN
    DECLARE i INT DEFAULT 1;
    DECLARE max_med_id INT;

    -- Get highest med_id available
    SELECT MAX(med_id) INTO max_med_id FROM medications;

    WHILE i <= 100000 DO
        INSERT INTO inventory (
            med_id,
            quantity,
            price,
            expiry_date,
            med_name,
            category_name,
            status
        )
        SELECT
            m.med_id,
            FLOOR(RAND() * 200) + 1,                      -- quantity 1–200
            ROUND(RAND() * 500 + 10, 2),                  -- price 10–510
            DATE_ADD(CURDATE(), INTERVAL FLOOR(RAND() * 720) DAY), -- expiry up to 2 years
            m.med_name,
            mc.category_name,
            IF(RAND() > 0.1, 'ACTIVE', 'EXPIRED')         -- 90% ACTIVE
        FROM medications m
        JOIN medication_categories mc ON m.category_id = mc.category_id
        WHERE m.med_id = (i MOD max_med_id) + 1
        LIMIT 1;

        SET i = i + 1;
    END WHILE;
END$$

DELIMITER ;

CALL generate_inventory_data();
SELECT COUNT(*) FROM inventory;



DROP TABLE IF EXISTS `medications`;
CREATE TABLE IF NOT EXISTS `medications` (
  `med_id` int(11) NOT NULL AUTO_INCREMENT,
  `med_name` varchar(100) NOT NULL,
  `category_id` int(11) DEFAULT NULL,
  `category_name` varchar(100) DEFAULT NULL,
  PRIMARY KEY (`med_id`),
  UNIQUE KEY `med_name` (`med_name`),
  KEY `category_id` (`category_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;



DROP TABLE IF EXISTS `medication_categories`;
CREATE TABLE IF NOT EXISTS `medication_categories` (
  `category_id` int(11) NOT NULL AUTO_INCREMENT,
  `category_name` varchar(100) NOT NULL,
  PRIMARY KEY (`category_id`),
  UNIQUE KEY `category_name` (`category_name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;



DROP TABLE IF EXISTS `medication_name_pool`;
CREATE TABLE IF NOT EXISTS `medication_name_pool` (
  `name` varchar(100) NOT NULL,
  PRIMARY KEY (`name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;



DROP TABLE IF EXISTS `purchases`;
CREATE TABLE IF NOT EXISTS `purchases` (
  `purchase_id` int(11) NOT NULL AUTO_INCREMENT,
  `supplier_id` int(11) DEFAULT NULL,
  `purchase_date` date DEFAULT NULL,
  `total_amount` decimal(10,2) DEFAULT NULL,
  PRIMARY KEY (`purchase_id`),
  KEY `supplier_id` (`supplier_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;



DROP TABLE IF EXISTS `purchase_details`;
CREATE TABLE IF NOT EXISTS `purchase_details` (
  `purchase_detail_id` int(11) NOT NULL AUTO_INCREMENT,
  `purchase_id` int(11) DEFAULT NULL,
  `supplier_name` varchar(100) DEFAULT NULL,
  `med_id` int(11) DEFAULT NULL,
  `med_name` varchar(100) DEFAULT NULL,
  `quantity` int(11) DEFAULT NULL,
  `cost` decimal(10,2) DEFAULT NULL,
  PRIMARY KEY (`purchase_detail_id`),
  KEY `purchase_id` (`purchase_id`),
  KEY `med_id` (`med_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;



DROP TABLE IF EXISTS `sales`;
CREATE TABLE IF NOT EXISTS `sales` (
  `sale_id` int(11) NOT NULL AUTO_INCREMENT,
  `sale_date` date DEFAULT NULL,
  `total_amount` decimal(10,2) DEFAULT NULL,
  `customer_id` int(11) DEFAULT NULL,
  PRIMARY KEY (`sale_id`),
  KEY `fk_sales_customer` (`customer_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;



DROP TABLE IF EXISTS `sale_details`;
CREATE TABLE IF NOT EXISTS `sale_details` (
  `sale_detail_id` int(11) NOT NULL AUTO_INCREMENT,
  `sale_id` int(11) DEFAULT NULL,
  `customer_id` int(11) DEFAULT NULL,
  `customer_name` varchar(100) DEFAULT NULL,
  `med_id` int(11) DEFAULT NULL,
  `med_name` varchar(100) DEFAULT NULL,
  `quantity` int(11) DEFAULT NULL,
  `price` decimal(10,2) DEFAULT NULL,
  PRIMARY KEY (`sale_detail_id`),
  KEY `sale_id` (`sale_id`),
  KEY `med_id` (`med_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;


DROP TABLE IF EXISTS `suppliers`;
CREATE TABLE IF NOT EXISTS `suppliers` (
  `supplier_id` int(11) NOT NULL AUTO_INCREMENT,
  `supplier_name` varchar(100) DEFAULT NULL,
  `phone` varchar(20) DEFAULT NULL,
  `email` varchar(50) DEFAULT NULL,
  `address` varchar(200) DEFAULT NULL,
  PRIMARY KEY (`supplier_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

DROP VIEW IF EXISTS `view_low_stock`;
CREATE TABLE IF NOT EXISTS `view_low_stock` (
`med_id` int(11)
,`med_name` varchar(100)
,`category_name` varchar(100)
,`quantity` decimal(33,0)
,`price` decimal(42,2)
);


DROP VIEW IF EXISTS `view_medication_inventory`;
CREATE TABLE IF NOT EXISTS `view_medication_inventory` (
`med_id` int(11)
,`med_name` varchar(100)
,`category_name` varchar(100)
,`quantity` decimal(33,0)
,`price` decimal(42,2)
);


DROP VIEW IF EXISTS `view_purchase_details`;
CREATE TABLE IF NOT EXISTS `view_purchase_details` (
`purchase_id` int(11)
,`purchase_date` date
,`med_id` int(11)
,`med_name` varchar(100)
,`quantity` int(11)
,`cost` decimal(10,2)
,`total_cost` decimal(20,2)
);


DROP VIEW IF EXISTS `view_purchase_readable`;
CREATE TABLE IF NOT EXISTS `view_purchase_readable` (
);


DROP VIEW IF EXISTS `view_sales_details`;
CREATE TABLE IF NOT EXISTS `view_sales_details` (
`sale_id` int(11)
,`sale_date` date
,`med_id` int(11)
,`med_name` varchar(100)
,`quantity` int(11)
,`price` decimal(10,2)
,`total_price` decimal(20,2)
);

DROP VIEW IF EXISTS `view_sales_readable`;
CREATE TABLE IF NOT EXISTS `view_sales_readable` (
`sale_id` int(11)
,`customer_name` varchar(100)
,`med_name` varchar(100)
,`quantity` int(11)
,`price` decimal(10,2)
,`sale_date` date
);


DROP VIEW IF EXISTS `view_sales_summary`;
CREATE TABLE IF NOT EXISTS `view_sales_summary` (
`med_name` varchar(100)
,`total_sold` decimal(32,0)
,`total_sales` decimal(42,2)
);


DROP TABLE IF EXISTS `view_low_stock`;

DROP VIEW IF EXISTS `view_low_stock`;
CREATE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `view_low_stock`  AS SELECT `view_medication_inventory`.`med_id` AS `med_id`, `view_medication_inventory`.`med_name` AS `med_name`, `view_medication_inventory`.`category_name` AS `category_name`, `view_medication_inventory`.`quantity` AS `quantity`, `view_medication_inventory`.`price` AS `price` FROM `view_medication_inventory` WHERE `view_medication_inventory`.`quantity` <= 10 ;


DROP TABLE IF EXISTS `view_medication_inventory`;

DROP VIEW IF EXISTS `view_medication_inventory`;
CREATE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `view_medication_inventory`  AS SELECT `m`.`med_id` AS `med_id`, `m`.`med_name` AS `med_name`, `c`.`category_name` AS `category_name`, ifnull(sum(`pd`.`quantity`),0) - ifnull(sum(`sd`.`quantity`),0) AS `quantity`, ifnull(sum(`sd`.`price` * `sd`.`quantity`),0) AS `price` FROM (((`medications` `m` join `medication_categories` `c` on(`m`.`category_id` = `c`.`category_id`)) left join `purchase_details` `pd` on(`m`.`med_id` = `pd`.`med_id`)) left join `sale_details` `sd` on(`m`.`med_id` = `sd`.`med_id`)) GROUP BY `m`.`med_id`, `m`.`med_name`, `c`.`category_name` ;


DROP TABLE IF EXISTS `view_purchase_details`;

DROP VIEW IF EXISTS `view_purchase_details`;
CREATE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `view_purchase_details`  AS SELECT `p`.`purchase_id` AS `purchase_id`, `p`.`purchase_date` AS `purchase_date`, `pd`.`med_id` AS `med_id`, `m`.`med_name` AS `med_name`, `pd`.`quantity` AS `quantity`, `pd`.`cost` AS `cost`, `pd`.`quantity`* `pd`.`cost` AS `total_cost` FROM ((`purchases` `p` join `purchase_details` `pd` on(`p`.`purchase_id` = `pd`.`purchase_id`)) join `medications` `m` on(`pd`.`med_id` = `m`.`med_id`)) ;


DROP TABLE IF EXISTS `view_purchase_readable`;

DROP VIEW IF EXISTS `view_purchase_readable`;
CREATE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `view_purchase_readable`  AS SELECT `p`.`purchase_id` AS `purchase_id`, `c`.`customer_name` AS `customer_name`, `m`.`med_name` AS `med_name`, `pd`.`quantity` AS `quantity`, `pd`.`cost` AS `cost`, `p`.`purchase_date` AS `purchase_date` FROM (((`purchases` `p` join `customers` `c` on(`p`.`customer_id` = `c`.`customer_id`)) join `purchase_details` `pd` on(`p`.`purchase_id` = `pd`.`purchase_id`)) join `medications` `m` on(`pd`.`med_id` = `m`.`med_id`)) ;


DROP TABLE IF EXISTS `view_sales_details`;

DROP VIEW IF EXISTS `view_sales_details`;
CREATE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `view_sales_details`  AS SELECT `s`.`sale_id` AS `sale_id`, `s`.`sale_date` AS `sale_date`, `sd`.`med_id` AS `med_id`, `m`.`med_name` AS `med_name`, `sd`.`quantity` AS `quantity`, `sd`.`price` AS `price`, `sd`.`quantity`* `sd`.`price` AS `total_price` FROM ((`sales` `s` join `sale_details` `sd` on(`s`.`sale_id` = `sd`.`sale_id`)) join `medications` `m` on(`sd`.`med_id` = `m`.`med_id`)) ;


DROP TABLE IF EXISTS `view_sales_readable`;

DROP VIEW IF EXISTS `view_sales_readable`;
CREATE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `view_sales_readable`  AS SELECT `s`.`sale_id` AS `sale_id`, `c`.`customer_name` AS `customer_name`, `m`.`med_name` AS `med_name`, `sd`.`quantity` AS `quantity`, `sd`.`price` AS `price`, `s`.`sale_date` AS `sale_date` FROM (((`sales` `s` join `customers` `c` on(`s`.`customer_id` = `c`.`customer_id`)) join `sale_details` `sd` on(`s`.`sale_id` = `sd`.`sale_id`)) join `medications` `m` on(`sd`.`med_id` = `m`.`med_id`)) ;


DROP TABLE IF EXISTS `view_sales_summary`;

DROP VIEW IF EXISTS `view_sales_summary`;
CREATE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `view_sales_summary`  AS SELECT `m`.`med_name` AS `med_name`, sum(`sd`.`quantity`) AS `total_sold`, sum(`sd`.`quantity` * `sd`.`price`) AS `total_sales` FROM (`sale_details` `sd` join `medications` `m` on(`sd`.`med_id` = `m`.`med_id`)) GROUP BY `m`.`med_name` ;


ALTER TABLE `customer_points`
  ADD CONSTRAINT `fk_points_customer` FOREIGN KEY (`customer_id`) REFERENCES `customers` (`customer_id`) ON DELETE CASCADE;

ALTER TABLE `inventory`
  ADD CONSTRAINT `inventory_ibfk_1` FOREIGN KEY (`med_id`) REFERENCES `medications` (`med_id`);


ALTER TABLE `medications`
  ADD CONSTRAINT `medications_ibfk_1` FOREIGN KEY (`category_id`) REFERENCES `medication_categories` (`category_id`);


ALTER TABLE `purchases`
  ADD CONSTRAINT `purchases_ibfk_1` FOREIGN KEY (`supplier_id`) REFERENCES `suppliers` (`supplier_id`);


ALTER TABLE `purchase_details`
  ADD CONSTRAINT `purchase_details_ibfk_1` FOREIGN KEY (`purchase_id`) REFERENCES `purchases` (`purchase_id`),
  ADD CONSTRAINT `purchase_details_ibfk_2` FOREIGN KEY (`med_id`) REFERENCES `medications` (`med_id`);


ALTER TABLE `sales`
  ADD CONSTRAINT `fk_sales_customer` FOREIGN KEY (`customer_id`) REFERENCES `customers` (`customer_id`) ON UPDATE CASCADE;


ALTER TABLE `sale_details`
  ADD CONSTRAINT `sale_details_ibfk_1` FOREIGN KEY (`sale_id`) REFERENCES `sales` (`sale_id`),
  ADD CONSTRAINT `sale_details_ibfk_2` FOREIGN KEY (`med_id`) REFERENCES `medications` (`med_id`);
COMMIT;

